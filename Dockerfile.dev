# ================================================
# Multi-stage Dockerfile –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# Elixir + Phoenix + Go + Python + Node.js + Dev Tools
# ================================================

FROM elixir:1.18.4-otp-28

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    TERM=xterm-256color

# ================================================
# –°–ò–°–¢–ï–ú–ù–´–ï –ü–ê–ö–ï–¢–´ –ò –ë–ê–ó–û–í–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
# ================================================
RUN apt-get update && apt-get install -y \
    # Build tools
    build-essential \
    cmake \
    automake \
    autoconf \
    # Version control
    git \
    git-lfs \
    # Network tools
    curl \
    wget \
    net-tools \
    iputils-ping \
    # System utilities
    vim \
    nano \
    tmux \
    screen \
    htop \
    tree \
    jq \
    unzip \
    zip \
    # Database clients
    postgresql-client \
    redis-tools \
    # SSL/TLS
    ca-certificates \
    openssl \
    libssl-dev \
    # –î–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    libncurses5-dev \
    libreadline-dev \
    zlib1g-dev \
    # Supervisor –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
    supervisor \
    # inotify –¥–ª—è file watching
    inotify-tools \
    # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    imagemagick \
    && rm -rf /var/lib/apt/lists/*

# ================================================
# NODE.JS –ò NPM (latest LTS)
# ================================================
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g npm@latest && \
    # –ü–æ–ª–µ–∑–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
    npm install -g \
    yarn \
    pnpm \
    @anthropic-ai/claude-code \
    eslint \
    prettier \
    typescript \
    ts-node \
    && rm -rf /var/lib/apt/lists/*

# ================================================
# PYTHON (latest stable)
# ================================================
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    python3-venv \
    && ln -sf /usr/bin/python3 /usr/bin/python \
    && python3 -m pip install --upgrade pip setuptools wheel \
    && python3 -m pip install \
    # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    numpy \
    pandas \
    matplotlib \
    requests \
    pytest \
    ipython \
    # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—Ä–∏–ø—Ç–æ API
    python-binance \
    ccxt \
    && rm -rf /var/lib/apt/lists/*

# ================================================
# GO (latest stable version)
# ================================================
ARG GO_VERSION=1.23.5
RUN wget -q https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz && \
    rm go${GO_VERSION}.linux-amd64.tar.gz

ENV PATH="/usr/local/go/bin:${PATH}" \
    GOPATH="/go" \
    GOBIN="/go/bin"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö Go –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
RUN mkdir -p "$GOPATH/src" "$GOPATH/bin" && \
    go install github.com/cosmtrek/air@latest && \
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# ================================================
# ELIXIR –ò–ù–°–¢–†–£–ú–ï–ù–¢–´
# ================================================
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Hex –∏ Rebar
RUN mix local.hex --force && \
    mix local.rebar --force

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Phoenix –∏ –¥—Ä—É–≥–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤
RUN mix archive.install hex phx_new --force && \
    mix archive.install hex nerves_bootstrap --force

# ================================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ò
# ================================================

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ExDoc –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
RUN mix escript.install hex ex_doc --force

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ watchexec –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
RUN wget -qO- https://github.com/watchexec/watchexec/releases/latest/download/watchexec-1.25.1-x86_64-unknown-linux-musl.tar.xz | \
    tar xJv -C /usr/local/bin --strip-components=1 watchexec-1.25.1-x86_64-unknown-linux-musl/watchexec || \
    echo "watchexec install failed, skipping"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ lazygit (—É–¥–æ–±–Ω—ã–π TUI –¥–ª—è Git)
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*') && \
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" && \
    tar xf lazygit.tar.gz -C /usr/local/bin lazygit && \
    rm lazygit.tar.gz

# ================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –†–ê–ë–û–ß–ï–ô –î–ò–†–ï–ö–¢–û–†–ò–ò
# ================================================
WORKDIR /app

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è supervisor
COPY <<EOF /etc/supervisor/conf.d/supervisord.conf
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:shell]
command=/bin/bash
autostart=false
autorestart=false
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p /var/log/supervisor

# ================================================
# –ù–ê–°–¢–†–û–ô–ö–ê TMUX
# ================================================
COPY <<EOF /root/.tmux.conf
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ tmux –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
set -g default-terminal "screen-256color"
set -g history-limit 10000
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1

# –ü—Ä–µ—Ñ–∏–∫—Å –∫–æ–º–∞–Ω–¥ (Ctrl+a –≤–º–µ—Å—Ç–æ Ctrl+b)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# –ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
bind r source-file ~/.tmux.conf \; display "–ö–æ–Ω—Ñ–∏–≥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω!"

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–∫–æ–Ω
bind | split-window -h
bind - split-window -v

# –°—Ç–∞—Ç—É—Å –±–∞—Ä
set -g status-style bg=colour235,fg=colour136
set -g status-left '[#S] '
set -g status-right '%Y-%m-%d %H:%M'
EOF

# ================================================
# –ù–ê–°–¢–†–û–ô–ö–ê VIM (–±–∞–∑–æ–≤–∞—è)
# ================================================
COPY <<EOF /root/.vimrc
" –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Vim
syntax on
set number
set relativenumber
set tabstop=2
set shiftwidth=2
set expandtab
set autoindent
set smartindent
set ruler
set showcmd
set incsearch
set hlsearch
set ignorecase
set smartcase
set background=dark
colorscheme desert
EOF

# ================================================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ò
# ================================================
ENV PATH="${PATH}:${GOBIN}:/root/.mix/escripts" \
    ERL_AFLAGS="-kernel shell_history enabled" \
    MIX_ENV=dev \
    NODE_ENV=development

# ================================================
# EXPOSE PORTS
# ================================================
# Phoenix server
EXPOSE 4000
# Phoenix LiveReload
EXPOSE 4001
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
EXPOSE 4002 4003 4004

# ================================================
# HEALTH CHECK
# ================================================
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:4000/api/health || exit 1

# ================================================
# ENTRYPOINT
# ================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
COPY <<'EOF' /docker-entrypoint.sh
#!/bin/bash
set -e

echo "üöÄ Starting Binance Trading System Development Environment"
echo "================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$DATABASE_URL" ] && [ -z "$POSTGRES_HOST" ]; then
    echo "‚ö†Ô∏è  WARNING: Database configuration not found"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if [ -f "mix.exs" ]; then
    echo "üì¶ Installing Elixir dependencies..."
    mix deps.get

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Phoenix
    if [ -d "assets" ]; then
        echo "üì¶ Installing Node.js dependencies..."
        cd assets && npm install && cd ..
    fi
fi

echo "================================================"
echo "‚úÖ Environment ready!"
echo ""
echo "Available commands:"
echo "  mix phx.server      - Start Phoenix server"
echo "  mix test            - Run tests"
echo "  iex -S mix          - Start IEx with project"
echo "  lazygit             - Git TUI"
echo "  claude-code         - Start Claude Code"
echo ""
echo "Tmux shortcuts:"
echo "  Ctrl+a |  - Split vertically"
echo "  Ctrl+a -  - Split horizontally"
echo "  Ctrl+a d  - Detach session"
echo "================================================"

exec "$@"
EOF

RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["sleep", "infinity"]
